# HTTPでやり取りする仕組み

## 01. HTTPメッセージ

HTTP (Hyper Text Transfer Protocol) のメッセージは
Webブラウザからの要求である「 __HTTPリクエスト__ 」と
Webサーバーからの応答である「 __HTTPレスポンス__ 」の
２種類に別れる

## 02. HTTPリクエスト/HTTPレスポンス

**HTTPリクエスト**
「リクエスト行」「メッセージヘッダー」「メッセージボディ」の3つに分けることができる。

- __リクエスト行__ : Webサーバーへの処理のリクエスト内容

- __メッセージヘッダー__ : Webブラウザの種類やバージョン、対応するデータ形式など負荷的な情報を記述

- __メッセージボディ__ : Webページ内のフォーム欄などに入力したテキストデータをWebサーバーに送る目的で使われる

**HTTPレスポンス**
「ステータス行」「メッセージヘッダー」「メッセージボディ」の３つに分けることができる。

- __ステータス行__ : Webブラウザから受け取ったHTTPリクエストに対してWebサーバーないでの処理結果を伝える。

- __メッセージヘッダー__ : Webサーバーの種類や、送信するデータの形式などの蓋的な情報を記述。

- __メッセージボディ__ : WebブラウザからリクエストされたHTMLなどのデータが格納されている。

**HTTPリクエスト**
```
    // ①リクエスト行 Webサーバーに対してどのような処理を依頼するのかを伝える情報が含まれている。
    // メソッド パス名 バージョン
    GET /index.html HTTP/1.1
    
    // ②メッセージヘッダー Webブラウザの種類や、対応しているデータのタイプ、データの圧縮方法、言語などの情報を伝える
    Host: example.com
    User-Agent: Mozilla/5.0(Windows NT 6.1; Win64; x64)
    Accept: text/html,application/xhtml+xml,application/xml
    Accept-Encodeing: gizip, deflate, sdch
    Accept-Language: ja, en-US; q=0.8, en=0.6
    Connection: Keep-Alive

    // ③ 空白行 1行空けることでメッセージヘッダーの終わりを告げる

    // ④ メッセージボディ Webサーバーにデータを送るために使われる
```

**HTTPリクエスト**
```
    // ①ステータス行 WebブラウザにWebサーバーないでの処理の結果を伝える
    // バージョン ステータスコード テキストフレーズ
    HTTP/1.1 200 OK

    // ②メッセージヘッダー Webサーバーのソフトウェア情報や、返信するデータのタイプ、データの圧縮方法などの情報を伝える。
    Server: Apache
    Date: Fri, 18 Oct 2016 0-9:35:04 GMT
    Content-type: text/html;charset=UTG-8
    Content-encoding: qzip

    // ③空白行 1行空けることでメッセージヘッダーの終わりを伝える

    // ④メッセージボディ HTMLや画像などのデータを格納する場所
```

## 03. HTTPメソッド

**HTTPメソッド**
HTTPリクエストを用いてWebサーバーに具体的な要求を伝えているもの

GET : URLの後ろにデータを含めて送る。Webブラウザの閲覧履歴に残る
POST : メッセージボディにデータを含めて送る。閲覧履歴に残らない

GETメソッドでログイン機能などを作るとブラウザに閲覧履歴として残ってしまうため個人情報をWebサーバーに送る際はPOSTメソッドが使われる。

URLの最大文字数 : 2083文字

| HTTPメソッド名 | 説明 |
|---|---|---|
| HEAD | HTTPヘッダーの情報のみを取得するHTTPメソッド。データの更新日時やデータのサイズのみを取得したい場合に利用する。 |
| GET | HTMLファイルや画像といったデータを取得する場合に利用する。Webサイト閲覧時において使用頻度が高い |
| POST | フォームに入力したパスワードといったデータを転送する場合に利用する |
| PUT | データ(ファイル)アップロードする場合に利用する。Webサーバー上のファイルを置き換えることができるため、利用できないように制限されている場合が多い |
| DELETE | 指定したデータ(ファイル)を削除する場合に利用する。 PUTメソッド同様に利用できないように制限されている場合が多い |
| CONNECT | Webサーバーに接続するまでに別のサーバーを中継する場合に利用する。CONNECTメソッドを悪用した攻撃があるため、利用を制限されている場合が多い。 |
| OPTIONS | 利用できるHTTPメソッドを問い合わせる場合に利用する。PUTやDELETEメソッドのように利用を制限されているHTTPメソッドがあるため、事前に機能を確認する際に利用する。 |
| TRACE | WebブラウザとWebサーバーの経路をチェックする場合に利用する。TRACEメソッドを悪用した攻撃があるため、利用を制限されている場合が多い。 |

## 04. ステータスコード

**ステータスコード**
HTTPリクエストに対してHTTPレスポンス内に記載されるWebサーバー内での処理結果
3桁の数字からなり、処理内容によって100番から500番台までの５つに分類される

- 100番台: HTTPリクエスを処理中であることを通知している。Webサーバーがデータを受入可能かどうかを確認するために一時応答で使用される。

<br>

- 200番台: HTTPリクエストに対して、正常に処理した場合に通知する。Webブラウザ上でWebサイトが正常に表示された場合は、ほとんどがこのステータスコード

<br>

- 300番台: HTTPリクエストに対して、転送処理などのWebブラウザ側で追加の処理が必要であることを通知している。WebサイトのURLが変更されている場合などに通知される。

<br>

- 400番台: クライアント（Webブラウザ）のエラーであることを通知している。リクエストされたHTMLファイルなどがWebサーバーに存在しない場合にこのステータスコードを返す。

<br>

- 500番台: Webサーバーのエラーであることを通知している。Webサーバーの何らかのエラーによってリクエストに答えられない場合や、高負荷状態で一時的にWebコンテンツを転送できない場合にこのステータスコードを返す。

<table>
    1xx Infromation (情報)
    <tr> 
        <th style="background-color: #faebd7;">100</th>
        <td>continue</td>
        <td>リクエスト継続中を通知する</td>
    </tr>
</table>

<table>
    2xx Success (成功)
    <tr> 
        <th style="background-color: #faebd7;">200</th>
        <td>OK</td>
        <td>リクエストが正常に受理されたことを通知する</td>
    </tr>
</table>

<table>
    3xx Redirection (転送) 
    <tr> 
        <th style="background-color: #faebd7;">301</th>
        <td>Move Paramanently</td>
        <td>リクエストされたコンテンツが移動したことを通知する</td>
    </tr>
    <tr> 
        <th style="background-color: #faebd7;">302</th>
        <td>Found</td>
        <td>リクエストされたコンテンツが一時的に移動（別の場所で発見）したことを通知する</td>
    </tr>
    <tr> 
        <th style="background-color: #faebd7;">303</th>
        <td>Not Modified</td>
        <td>リクエストされたコンテンツが未更新であることを通知する。Webブラウザに一時保存されたコンテンツが表示される。</td>
    </tr>
</table>

<table>
    4xx Client Error (クライアントエラー)
    <tr> 
        <th style="background-color: #faebd7;">400</th>
        <td>Bad Request</td>
        <td>リクエストが不正であることを通知する。</td>
    </tr>
    <tr> 
        <th style="background-color: #faebd7;">404</th>
        <td>Not Found</td>
        <td>リクエストされたコンテンツが未検出であることを通知する。</td>
    </tr>
</table>

<table>
    5xx Server Error (サーバーエラー)
    <tr> 
        <th style="background-color: #faebd7;">500</th>
        <td>Internal Server Error</td>
        <td>リクエスト処理中にサーバー内部でエラーが発生したことを通知する。</td>
    </tr>
    <tr> 
        <th style="background-color: #faebd7;">503</th>
        <td>Service Unavailable</td>
        <td>アクセス集中やメンテナンスなどの理由で一時的に処理負荷であることを通知する。</td>
    </tr>
</table>

## 05. メッセージヘッダー

**メッセージヘッダー**
これを利用することで、HTTPメッセージに関する詳細な情報を送信することが可能。
複数の __ヘッダーフィールド__ と呼ばれる行から成り立っている。

**一般的なヘッダーフィールド**
| 名前 | 内容 |
|---|---|
| Connection | リクエスト後はTCPコネクションを切断などしょつぞく状態に関する通知 |
| Date | HTTPメッセージが作成された日付 |
| Ungrade | HTTPのバージョンをアップデートするように要求 |

**リクエストヘッダーフィールド**
| 名前 | 内容 |
|---|---|
| Host | リクエスト先のサーバー名 |
| Referer | 直前にリンクしていた(訪れていた)WebページのURL |
| User-Agent | Webブラウザの固有情報(プロダクト名、バージョンなど) |

**レスポンスヘッダーフィールド**
| 名前 | 内容 |
|---|---|
| Location | リダイレクト先のWebページの情報 |
| Server | Webサーバーの固有情報(プロダクト名、バージョンなど) |

**エンティティヘッダーフィールド**
| 名前 | 内容 |
|---|---|
| Allow | 利用可能なHTTPメソッドの一覧 |
| Content-Encoding | コンテンツのエンコード（データ変換）方式 |
| Content-Language | コンテンツの使用言語 |
| Content-Length | コンテンツのサイズ。単位はバイト（byte） |
| Content-Type | コンテンツの種類（テキスト、画像など） |
| Expires | コンテンツの有効期限 |
| Last-Modified | コンテンツの最終更新時刻 |

※ ヘッダーフィールドは独自に定義したものを利用することも可能

## 06. TCPによるデータ通信

**コネクション**
TCPではまずクライアントとサーバーがお互いに通信できる状態なのかを確認し、通信経路を確立した上でデータのやり取りを行う。

コネクションの確率は3回のやりとりによって行われるため「３ウェイハンドシェイク」と呼ばれる
- クライアントからの接続要求（SYN）
- クライアントに対して確認応答及び、サーバーからの接続要求（SYN＋ACK）
- サーバーに対して確認応答（ACK）

## 07. HTTP/1.1のやり取り

HTTPレスポンスとしてデータを引き渡した段階でコネクションを閉じるという方式が用いられていた。そのため、Webページ内に画像が埋め込まれていた場合、一度コネクションを確立し、Webページを受け取った後にコネクションをとじ、画像を取得するためにサイドコネクションを確率する必要があった。

**HTTPキープアライン**
上記の状況を改善するために作成された機能
コネクションを継続して利用する方式

**HTTPパイプライン**
HTTPでは通常１つのHTTPリクエストを送信し、それに対するHTTPレスポンスを受け取るまでは次のHTTPリクエストを送信することはできないが、HTTPパイプラインはHTTPレスポンスを待つことなく複数のHTTPリクエストを送信することを可能とする。

## 08. HTTP/2のやり取り 

**HTTP/2**
Googleが提案したSPDYと呼ばれる通信の高速化を目的としたプロトコルがベースとなっており、
2015年５月に正式に標準化された。

HTTP/1.0ではHTTPパイプライン機能がサポートされていたが、「HTTPリクエストの順番通りにHTTPレスポンスを返さなければいけない」という制約があったため、ある１つのHTTPレスポンスの処理に時間がかかる場合、それ以降のHTTPレスコンスはその処理が終わるなで待つ必要があり、Webページの表示速度が遅くなるといった問題点があった。

**ストリーム**
上記を改善するために作成された機能
TCPコネクション上に「ストリーム」と呼ばれる仮想的な経路を複数生成し、それぞれのストリームないでHTTPリクエストとHTTPレスポンスを可能としている。
ここのストリームは独立していて、並行してHTTPリクエストとHTTPレスポンスのやり取りができる。

## 09. HTTP/2での改良点

HTTP/1.1以前ではテキスト形式のフォーマットでHTTPリクエストやHTTPレスポンスのやり取りを行っていたが、HTTP/2では、より効率的にデータをやり取りするためにバイナリ形式のフォーマットを用いるようになった。

**HPACK**
HTTP/2ではHTTPリクエストやHTTPレスポンスのやり取りをするたびに重複したデータを転送するといった事態を改善するためにヘッダー情報の中から差分だけを送るHPACKと呼ばれる圧縮方式を利用した。

**サーバープッシュ**
HTTPリクエストの内容をもとにWebサーバー側で必要なファイルを判別して、WebブラウザからのHTTPリクエストなしに、事前にWebサーバーから転送する。

## 10. HTTPSの仕組み

**HTTPS**
クレジットカード番号が盗聴されたり、注文内容が改竄されたり、「なりすましサイト」により個人情報が盗まれたりする危険性があるため、こういった脅威から大切なデータを守仕組み。

HTTP over SSL/TLS の略で、HTTPの通信において、暗号化方式であるSSL(Secure Sockets Layer) や TLS（Transport Layer Security）を利用することでWebサイトを安全に使うことができる。

HTTPSで利用されるSSL/TLSでは、３つの仕組みによりWebサイトの安全性を確保する。
- 盗聴防止
万が一通信を傍受されても内容を解読させないためにデータを暗号化して送る
- 改竄防止
ネットバンキングにおいて振り込み先情報が書き換えられてしまうといったデータの改竄対策として、「 __メッセージダイジェスト__ 」が利用される。
あるデータから一意の短いデータ（ハッシュ値）をとり出す計算のこと。データ送受信時にハッシュ値を比較して改竄を感知できる。
- なりすまし防止（Webサイトの運用元の確認）
Webサーバーに「 __SSLサーバー証明書__ 」と呼ばれるでんし証明書を配置しておき、接続時に検証することにより、Webサイトを運営する会社の身元を確認できる。
SSLサーバー証明書は発行を認められた「認定局」による運営元の認証作業を通過する必要があり、信頼できない発行元のSSLサーバー証明書が利用されている場合はWebブラウザ上に警告画面が表示される。

## 11. HTTPSのやり取り

HTTPSの通信を開始するのには、大きく分けて４つのフェーズのやり取りを行う必要がある。(__SSL/TLSハンドシェイク__)

1. 暗号化方式の決定
暗号化方式は多数存在するため、WebブラウザとWebサーバーの両方が利用可能な暗号化方式を決める必要がある。
<br>
2. 通信相手の証明
Webブラウザが通信している「Webサーバーが正しい相手なのかどうかをSSLサーバー証明書により確認する。
<br>
3. 鍵の交換
暗号化、復号に利用する鍵を交換する。
<br>
4. 暗号化方式の確認
暗号化方式の最終確認を行う。

## 12. ステートフルとステートレス

**ステートレス**
Stateless
状態を保持しないという意味で、HTTPリクエスト/レスポンスの１往復のやり取りが完結された処理とみなされ、複数の処理を関連付ける仕組みがない。

**ステートフル**
Stateful
状態を保持するという意味

## 13. Cookie(クッキー)

**Cookie**
状態を保持し管理する必要がある場合に用いるデータ

Cookieの送信にはメッセージヘッダーが用いられる。
WebサーバーはHTTPレスポンスに __「Set-Cookie」ヘッダー__ を含めることでCookieを送信でき、
WebブラウザはHTTPリクエストに __「Cookie」ヘッダー__ を含めることで送信でいる。

有効期限が設定されていないCookieは、Webブラウザが閉じられると同時に削除され、このようなCookieを「__セッションCookie__」と呼ぶ。
<br>
**Cookieで利用されるヘッダーフィールド**
| 名前 | 内容 | 種別 |
|---|---|---|
| Set-Cookie | 状態を保持・管理するための情報（Cookie） | レスポンスヘッダーフィールド |
| Cookie | Webサーバーから受け取ったCookieの値 | リクエストヘッダーフィールド |

**Set-Cookieヘッダーフィールドに記述する属性**
| 属性 | 内容 |
|---|---|
| name=value | Cookieにつける名前とその値（必須） |
| expires=date | Cookieの有効期限。この属性がない場合はWebブラウザを閉じるとCookieは削除される。 |
| max-age=seconds | Cookieの残存時間を秒数で指定 |
| secure | HTTPSで通信している場合にのみCookieを送信 |
| httponly | JavascriptからのCookieへの参照制限 |
| domain=DOMAIN_NAME | Cookieが利用されるドメイン名 |
| path=PATH | Cookieが利用されるサーバー上のパス |

## 14. セッション

## 15. URI

## column Webサイトの「HTTPS」化がとまらない?
